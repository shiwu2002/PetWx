<!--pages/SuppliesDetail/SuppliesDetail.wxml-->
<view class="container">
  <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>
  <view wx:if="{{error}}" class="error">åŠ è½½å¤±è´¥ï¼Œè¯·è¿”å›é‡è¯•</view>
  <view wx:if="{{supply}}">
    <!-- é¡¶éƒ¨å¤§å›¾æ¨ªå¹… -->
    <view class="banner-box">
      <image class="banner-img" src="{{supply.imageUrl}}" mode="aspectFill" />
    </view>
    <!-- ä¸»ä¿¡æ¯å¡ç‰‡ -->
    <view class="main-info-card">
      <view class="main-title-row">
        <text class="main-name">{{supply.productName}}</text>
        <text wx:if="{{supply.isHot == 1}}" class="main-hot">çƒ­é”€</text>
      </view>
      <view class="main-meta-row">
        <text class="main-category">{{supply.category}}</text>
        <text class="main-brand">å“ç‰Œï¼š{{supply.brand}}</text>
      </view>
      <view class="main-price-row">
        <text class="main-price">ï¿¥{{supply.price}}</text>
        <text class="main-rating">è¯„åˆ†ï¼š{{supply.rating}}åˆ†</text>
      </view>
    </view>
    <!-- å‚æ•°ä¿¡æ¯è¡¨æ ¼ -->
    <view class="param-table">
      <view class="param-row"><text class="param-label">åº“å­˜</text><text class="param-value">{{supply.stockQuantity}}</text></view>
      <view class="param-row"><text class="param-label">é‡é‡</text><text class="param-value">{{supply.productWeight}}g</text></view>
      <view class="param-row"><text class="param-label">å°ºå¯¸</text><text class="param-value">{{supply.sizeDimensions}}</text></view>
      <view class="param-row"><text class="param-label">æè´¨</text><text class="param-value">{{supply.materials}}</text></view>
    </view>
    <!-- å•†å“ç®€ä»‹åˆ†å— -->
    <view class="desc-block">
      <text class="desc-title">å•†å“ç®€ä»‹</text>
      <text class="desc-content">{{supply.description}}</text>
    </view>
    <!-- æ—¶é—´ä¿¡æ¯å¼±åŒ– -->
    <view class="time-row">
      <text class="time-info">ç”Ÿäº§æ—¥æœŸï¼š{{supply.manufactureDate}}</text>
      <text wx:if="{{supply.expiryDate}}" class="time-info">æœ‰æ•ˆæœŸè‡³ï¼š{{supply.expiryDate}}</text>
    </view>
    <view class="time-row">
      <text class="time-info">åˆ›å»ºï¼š{{supply.createdAt}}</text>
      <text class="time-info">æ›´æ–°ï¼š{{supply.updatedAt}}</text>
    </view>
    <!-- åº•éƒ¨å¸åº•æ“ä½œæŒ‰é’® -->
    <view class="bottom-bar">
      <!-- è¯„è®ºå›¾æ ‡ -->
      <view class="comment-icon" bindtap="toggleCommentModal">
        <image src="/components/IMAGES/comment.png" class="comment-img" />
        <text class="comment-text">è¯„è®º</text>
        <text wx:if="{{commentCount > 0}}" class="comment-count">{{commentCount}}</text>
      </view>
      <button class="buy-btn" bindtap="onBuyTap">ç«‹å³è´­ä¹°</button>
      <button class="cart-btn">åŠ å…¥è´­ç‰©è½¦</button>
    </view>
    <!-- è´­ä¹°å¼¹çª— -->
    <view wx:if="{{showBuyPopup}}" class="buy-popup-mask">
      <view class="buy-popup">
        <view class="buy-popup-title">è´­ä¹°æ•°é‡</view>
        <input class="buy-popup-input" type="number" min="1" :max="{{supply.stockQuantity}}" value="{{buyNum}}" bindinput="onBuyNumInput" />
        <view class="buy-popup-actions">
          <button class="buy-popup-cancel" bindtap="onCloseBuyPopup">å–æ¶ˆ</button>
          <button class="buy-popup-confirm" loading="{{buyLoading}}" bindtap="onConfirmBuy">ç¡®è®¤è´­ä¹°</button>
        </view>
      </view>
    </view>
    
    <!-- è¯„è®ºå¼¹çª— -->
    <view wx:if="{{showCommentModal}}" class="comment-modal-mask" bindtap="toggleCommentModal">
      <view class="comment-modal" catchtap="stopPropagation">
        <view class="comment-header">
          <text class="comment-title">å•†å“è¯„è®º</text>
          <text class="comment-count-text">(å…±{{commentCount}}æ¡)</text>
          <view class="comment-close" bindtap="toggleCommentModal">Ã—</view>
        </view>
        
        <!-- è¯„è®ºè¾“å…¥æ¡† -->
        <view class="comment-input-container">
          <input class="comment-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." bindinput="onCommentInput" value="{{commentContent}}"/>
          <button class="send-btn" bindtap="submitComment" disabled="{{commentContent.trim()}}">å‘é€</button>
        </view>

        <!-- è¯„è®ºåˆ—è¡¨ -->
        <scroll-view class="comments-list" scroll-y="true">
          <block wx:for="{{comments}}" wx:key="id">
            <view class="comment-item">
              <view class="comment-header-item">
                <view class="avatar" wx:if="{{item.userAvatar}}">
                  <image src="{{item.userAvatar}}" mode="aspectFill"></image>
                </view>
                <view class="avatar" wx:else>
                  <text class="avatar-text">{{item.userName ? item.userName.substring(0, 1) : 'æœª'}}</text>
                </view>
                <view class="comment-info">
                  <text class="user-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
                  <text class="comment-time">{{item.createTime || 'åˆšåˆš'}}</text>
                </view>
                <view class="comment-actions">
                  <view class="action-btn reply-btn" bindtap="showReplyBox" data-id="{{item.id}}" data-name="{{item.userName}}">
                    <text class="action-icon">ğŸ’¬</text>
                    <text class="action-text">å›å¤</text>
                  </view>
                  <view class="action-btn delete-btn" bindtap="deleteComment" data-id="{{item.id}}" wx:if="{{item.userId === userId}}">
                    <text class="action-icon">ğŸ—‘ï¸</text>
                  </view>
                </view>
              </view>
              <view class="comment-content">
                <text wx:if="{{item.parentId && item.parentUserName}}">@{{item.parentUserName}}: </text>
                <text>{{item.content}}</text>
              </view>

              <!-- äºŒçº§è¯„è®º -->
              <view class="reply-list" wx:if="{{item.replies && item.replies.length > 0}}">
                <block wx:for="{{item.replies}}" wx:key="id" wx:for-item="reply">
                  <view class="reply-item">
                    <view class="comment-header-item">
                      <view class="avatar" wx:if="{{reply.userAvatar}}">
                        <image src="{{reply.userAvatar}}" mode="aspectFill"></image>
                      </view>
                      <view class="avatar" wx:else>
                        <text class="avatar-text">{{reply.userName ? reply.userName.substring(0, 1) : 'æœª'}}</text>
                      </view>
                      <view class="comment-info">
                        <text class="user-name">{{reply.userName || 'åŒ¿åç”¨æˆ·'}}</text>
                        <text class="comment-time">{{reply.createTime || 'åˆšåˆš'}}</text>
                      </view>
                      <view class="comment-actions">
                        <view class="action-btn reply-btn" bindtap="showReplyBox" data-id="{{reply.id}}" data-name="{{reply.userName}}">
                          <text class="action-icon">ğŸ’¬</text>
                          <text class="action-text">å›å¤</text>
                        </view>
                        <view class="action-btn delete-btn" bindtap="deleteComment" data-id="{{reply.id}}" wx:if="{{reply.userId === userId}}">
                          <text class="action-icon">ğŸ—‘ï¸</text>
                        </view>
                      </view>
                    </view>
                    <view class="comment-content">
                      <text wx:if="{{reply.parentId && reply.parentUserName}}">@{{reply.parentUserName}}: </text>
                      <text>{{reply.content}}</text>
                    </view>

                    <!-- äºŒçº§è¯„è®ºçš„å›å¤è¾“å…¥æ¡† -->
                    <view class="reply-input-container" wx:if="{{showReplyId === reply.id}}">
                      <input class="reply-input" placeholder="å›å¤ {{reply.userName}}..." bindinput="onReplyInput" value="{{replyContent}}"/>
                      <view class="reply-btns">
                        <button class="send-btn" bindtap="submitReply" data-id="{{reply.id}}" disabled="{{replyContent.trim()}}">å‘é€</button>
                      </view>
                    </view>
                  </view>
                </block>
              </view>

              <!-- ä¸€çº§è¯„è®ºçš„å›å¤è¾“å…¥æ¡† -->
              <view class="reply-input-container" wx:if="{{showReplyId === item.id}}">
                <input class="reply-input" placeholder="å›å¤ {{item.userName}}..." bindinput="onReplyInput" value="{{replyContent}}"/>
                <view class="reply-btns">
                  <button class="send-btn" bindtap="submitReply" data-id="{{item.id}}" disabled="{{replyContent.trim()}}">å‘é€</button>
                </view>
              </view>
            </view>
          </block>
          <view class="no-comments" wx:if="{{comments.length === 0}}">
            <text>æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</text>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>
</view> 