<view class="chat-container">
  <!-- èŠå¤©å¤´éƒ¨ -->
  <view class="chat-header">
    <view class="header-content">
      <view class="chat-info">
        <image class="chat-avatar" src="{{targetAvatar}}" mode="aspectFill"/>
        <view class="chat-details">
          <text class="chat-name">{{targetName}}</text>
          <text class="chat-status">{{isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
        </view>
      </view>
      <view class="header-actions">
        <view class="action-btn" bindtap="showChatOptions">
          <text class="action-icon">â‹¯</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view scroll-y="true" class="msg-list" scroll-with-animation scroll-into-view="{{toView}}">
    <view class="chat-date-divider" wx:if="{{showDateDivider}}">
      <text class="date-text">{{todayDate}}</text>
    </view>
    
    <block wx:for="{{messages}}" wx:key="timestamp">
      <view class="msg-row {{item.sender == userId ? 'me' : 'other'}}" id="msg-{{item.timestamp}}">
        <view class="msg-bubble-wrap {{item.sender == userId ? 'me' : 'other'}}">
          <!-- å¯¹æ–¹å¤´åƒ -->
          <image wx:if="{{item.sender != userId}}" class="avatar" src="{{item.senderAvatar || targetAvatar}}" mode="aspectFill"/>
          
          <!-- æ¶ˆæ¯å†…å®¹ -->
          <view class="msg-item {{item.sender == userId ? 'me' : 'other'}}">
            <view class="msg-meta">
              <text class="msg-username">
                {{item.senderName || (item.sender == userId ? 'æˆ‘' : 'å¯¹æ–¹')}}
                <text wx:if="{{item.sender == targetId}}" class="service-tag">ï¼ˆå®¢æœï¼‰</text>
              </text>
              <text class="msg-time">{{item.timeStr || ''}}</text>
            </view>
            <view class="msg-content">
              <text class="msg-text">{{item.content}}</text>
            </view>
            <view class="msg-status" wx:if="{{item.sender == userId}}">
              <text class="status-icon {{item.status}}">{{item.status === 'sending' ? 'â³' : (item.status === 'sent' ? 'âœ“' : (item.status === 'delivered' ? 'âœ“âœ“' : 'âœ“âœ“'))}}</text>
            </view>
          </view>
          
          <!-- æˆ‘çš„å¤´åƒ -->
          <image wx:if="{{item.sender == userId}}" class="avatar" src="{{userInfo.avatarUrl || '/components/IMAGES/1293.jpg_wh860.jpg'}}" mode="aspectFill"/>
        </view>
      </view>
    </block>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{messages.length === 0}}" class="empty-chat">
      <view class="empty-icon">ğŸ’¬</view>
      <text class="empty-text">å¼€å§‹èŠå¤©å§</text>
      <text class="empty-desc">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹å¯¹è¯</text>
    </view>
  </scroll-view>

  <!-- è¡¨æƒ…é€‰æ‹©é¢æ¿ -->
  <view wx:if="{{showEmojiPanel}}" class="emoji-panel">
    <view class="emoji-grid">
      <block wx:for="{{emojiList}}" wx:key="index">
        <view class="emoji-item" bindtap="selectEmoji" data-emoji="{{item}}">
          <text class="emoji-text">{{item}}</text>
        </view>
      </block>
    </view>
  </view>

  <!-- è¾“å…¥æ  -->
  <view class="input-bar">
    <view class="input-wrapper">
      <input class="input" 
             value="{{inputValue}}" 
             bindinput="onInput" 
             placeholder="è¯·è¾“å…¥æ¶ˆæ¯..." 
             confirm-type="send" 
             bindconfirm="sendMsg"
             maxlength="500"/>
      <view class="input-actions">
        <view class="action-btn" bindtap="toggleEmojiPanel">
          <text class="action-icon">ğŸ˜Š</text>
        </view>
        <view class="action-btn" bindtap="showMore">
          <text class="action-icon">+</text>
        </view>
      </view>
    </view>
    <button class="send-btn {{inputValue ? 'active' : ''}}" bindtap="sendMsg" disabled="{{!inputValue}}">
      <text class="btn-text">å‘é€</text>
    </button>
  </view>

  <!-- èŠå¤©é€‰é¡¹å¼¹çª— -->
  <view wx:if="{{showOptions}}" class="options-modal" bindtap="hideChatOptions">
    <view class="options-content" catchtap="stopPropagation">
      <view class="option-item" bindtap="clearChat">
        <text class="option-icon">ğŸ—‘ï¸</text>
        <text class="option-text">æ¸…ç©ºèŠå¤©è®°å½•</text>
      </view>
      <view class="option-item" bindtap="blockUser">
        <text class="option-icon">ğŸš«</text>
        <text class="option-text">å±è”½ç”¨æˆ·</text>
      </view>
      <view class="option-item" bindtap="reportUser">
        <text class="option-icon">âš ï¸</text>
        <text class="option-text">ä¸¾æŠ¥ç”¨æˆ·</text>
      </view>
    </view>
  </view>
</view>