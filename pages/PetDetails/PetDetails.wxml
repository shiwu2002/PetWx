<!--pages/PetDetails/PetDetails.wxml-->
<view class="container">
  <!-- å® ç‰©å›¾ç‰‡è½®æ’­ -->
  <view class="pet-image-section" wx:if="{{pet}}">
    <swiper 
      class="image-swiper" 
      indicator-dots="{{imageCount > 1}}" 
      indicator-color="rgba(255, 255, 255, 0.5)"
      indicator-active-color="#ffffff"
      autoplay="{{imageCount > 1}}" 
      interval="5000" 
      duration="500"
      bindchange="onSwiperChange"
      circular="{{imageCount > 1}}"
      current="{{currentImageIndex}}"
    >
      <swiper-item wx:for="{{(pet.images && pet.images.length > 0) ? pet.images : [pet.processedImageUrl]}}" wx:key="*this">
        <image 
          class="pet-image" 
          src="{{item}}" 
          mode="aspectFill" 
          binderror="onImageError" 
          bindtap="previewImages"
          data-index="{{index}}"
          lazy-load="true"
        />
      </swiper-item>
    </swiper>
    

    
    <!-- å›¾ç‰‡è®¡æ•°å™¨ -->
    <view class="image-counter" wx:if="{{imageCount > 1}}">
      <text class="counter-text">{{currentImageIndex + 1}}/{{imageCount}}</text>
    </view>
    
    <view class="image-overlay">
      <view class="back-btn" bindtap="goBack">
        <text class="back-icon">â€¹</text>
      </view>
      <view class="share-btn" bindtap="sharePet">
        <text class="share-icon">ğŸ“¤</text>
      </view>
    </view>
    
    <!-- è½®æ’­æç¤º -->
    <view class="swipe-hint" wx:if="{{imageCount > 1}}">
      <text class="hint-text">æ»‘åŠ¨æˆ–ç‚¹å‡»ç®­å¤´æŸ¥çœ‹æ›´å¤šå›¾ç‰‡</text>
    </view>
  </view>

  <!-- å® ç‰©åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
  <view class="pet-info-card" wx:if="{{pet}}">
    <view class="pet-header">
      <view class="pet-title-section">
  <text class="pet-name">{{pet.name}}</text>
  <view class="pet-badges">
          <view class="status-badge {{pet.isAdopt === 'å¾…é¢†å…»' ? 'adoptable' : 'adopted'}}">
            <text class="badge-text">{{pet.isAdopt}}</text>
          </view>
          <view class="health-badge {{pet.healthStatus === 'å¥åº·' ? 'healthy' : 'sick'}}">
            <text class="badge-text">{{pet.healthStatus}}</text>
          </view>
        </view>
      </view>
      
  <view class="card-actions">
    <view class="like-section" catchtap="toggleLike" data-target-id="{{pet.id}}">
      <view class="like-icon {{likeStates[pet.id] ? 'liked' : ''}}">
        {{likeStates[pet.id] ? 'â¤ï¸' : 'ğŸ¤'}}
      </view>
    </view>
  </view>
  
  <view class="pet-meta-grid">
        <view class="meta-item">
          <view class="meta-icon">ğŸ•</view>
          <view class="meta-content">
            <text class="meta-label">å“ç§</text>
            <text class="meta-value">{{pet.breed}}</text>
          </view>
        </view>
        <view class="meta-item">
          <view class="meta-icon">ğŸ‚</view>
          <view class="meta-content">
            <text class="meta-label">å¹´é¾„</text>
            <text class="meta-value">{{pet.age}}å²</text>
          </view>
        </view>
        <view class="meta-item">
          <view class="meta-icon">âš§</view>
          <view class="meta-content">
            <text class="meta-label">æ€§åˆ«</text>
            <text class="meta-value">{{pet.gender}}</text>
          </view>
        </view>
        <view class="meta-item">
          <view class="meta-icon">ğŸ“</view>
          <view class="meta-content">
            <text class="meta-label">åœ°åŒº</text>
            <text class="meta-value">{{pet.location}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="pet-description">
      <text class="description-title">è¯¦ç»†ä»‹ç»</text>
      <text class="description-text">{{pet.description || 'æš‚æ— è¯¦ç»†ä»‹ç»'}}</text>
    </view>
  </view>

  <!-- ç–«è‹—ä¿¡æ¯å¡ç‰‡ -->
  <view class="vaccine-card" wx:if="{{!vaccineLoading && !vaccineError}}">
    <view class="card-header">
      <view class="card-icon">ğŸ’‰</view>
      <text class="card-title">å¥åº·æ¡£æ¡ˆ</text>
    </view>
    
    <view wx:if="{{vaccineInfo}}" class="vaccine-content">
      <view class="info-grid">
        <view class="info-item">
          <text class="info-label">ç–«è‹—è®°å½•</text>
          <text class="info-value">{{vaccineInfo.vaccineRecord || 'æ— '}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">ç»è‚²çŠ¶æ€</text>
          <text class="info-value {{vaccineInfo.sterilization === 1 ? 'success' : 'warning'}}">
            {{vaccineInfo.sterilization === 1 ? 'å·²ç»è‚²' : 'æœªç»è‚²'}}
          </text>
        </view>
        <view class="info-item">
          <text class="info-label">æœ€è¿‘ä½“æ£€</text>
          <text class="info-value">{{vaccineInfo.lastCheckupStr || 'æ— '}}</text>
        </view>
      </view>
    </view>
    
    <view wx:else class="empty-state">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-text">æš‚æ— å¥åº·æ¡£æ¡ˆ</text>
      <text class="empty-desc">è¯¥å® ç‰©æš‚æ— è¯¦ç»†çš„å¥åº·ä¿¡æ¯è®°å½•</text>
    </view>
  </view>
  
  <view wx:if="{{vaccineLoading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½å¥åº·æ¡£æ¡ˆä¸­...</text>
  </view>
  
  <view wx:if="{{vaccineError}}" class="error-state">
    <view class="error-icon">âš ï¸</view>
    <text class="error-text">å¥åº·æ¡£æ¡ˆè·å–å¤±è´¥</text>
    <button class="retry-btn" bindtap="retryLoadVaccine">
      <text class="btn-text">é‡è¯•</text>
    </button>
  </view>

  <!-- è¯„è®ºåŒº - ç›´æ¥æ˜¾ç¤ºåœ¨ä¸»é¡µé¢ -->
  <view class="comments-section" wx:if="{{pet}}">
    <view class="section-header">
      <text class="section-title">è¯„è®º</text>
      <text class="section-count">({{commentCount || 0}})</text>
    </view>

    <!-- è¯„è®ºè¾“å…¥æ¡† -->
    <view class="comment-input-container">
      <input class="comment-input" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." bindinput="onCommentInput" value="{{commentContent}}"/>
      <button class="send-btn" bindtap="submitComment" disabled="{{commentContent.trim()}}">å‘é€</button>
    </view>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <scroll-view class="comments-list" scroll-y="true">
      <block wx:for="{{comments}}" wx:key="id">
        <view class="comment-item" id="comment-{{item.id}}">
          <view class="comment-header">
            <view class="avatar" wx:if="{{item.userAvatar}}">
              <image src="{{item.userAvatar}}" mode="aspectFill"></image>
            </view>
            <view class="avatar" wx:else>
              <text class="avatar-text">{{item.userName ? item.userName.substring(0, 1) : 'æœª'}}</text>
            </view>
            <view class="comment-info">
              <text class="user-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="comment-time">{{item.createTime || 'åˆšåˆš'}}</text>
            </view>
            <view class="comment-actions">
              <view class="action-btn reply-btn" bindtap="showReplyBox" data-id="{{item.id}}" data-name="{{item.userName}}">
                <text class="action-icon">ğŸ’¬</text>
                <text class="action-text">å›å¤</text>
              </view>
              <view class="action-btn delete-btn" bindtap="deleteComment" data-id="{{item.id}}" wx:if="{{item.userId === userId}}">
                <text class="action-icon">ğŸ—‘ï¸</text>
              </view>
            </view>
          </view>
          <view class="comment-content">
            <text wx:if="{{item.parentId && item.parentUserName}}">@{{item.parentUserName}}: </text>
            <text>{{item.content}}</text>
          </view>

          <!-- äºŒçº§è¯„è®º -->
          <view class="reply-list" wx:if="{{item.replies && item.replies.length > 0}}">
            <block wx:for="{{item.replies}}" wx:key="id" wx:for-item="reply">
              <view class="reply-item" id="comment-{{reply.id}}">
                <view class="comment-header">
                  <view class="avatar" wx:if="{{reply.userAvatar}}">
                    <image src="{{reply.userAvatar}}" mode="aspectFill"></image>
                  </view>
                  <view class="avatar" wx:else>
                    <text class="avatar-text">{{reply.userName ? reply.userName.substring(0, 1) : 'æœª'}}</text>
                  </view>
                  <view class="comment-info">
                    <text class="user-name">{{reply.userName || 'åŒ¿åç”¨æˆ·'}}</text>
                    <text class="comment-time">{{reply.createTime || 'åˆšåˆš'}}</text>
                  </view>
                  <view class="comment-actions">
                    <view class="action-btn reply-btn" bindtap="showReplyBox" data-id="{{reply.id}}" data-name="{{reply.userName}}">
                      <text class="action-icon">ğŸ’¬</text>
                      <text class="action-text">å›å¤</text>
                    </view>
                    <view class="action-btn delete-btn" bindtap="deleteComment" data-id="{{reply.id}}" wx:if="{{reply.userId === userId}}">
                      <text class="action-icon">ğŸ—‘ï¸</text>
                    </view>
                  </view>
                </view>
                <view class="comment-content">
                  <text wx:if="{{reply.parentId && reply.parentUserName}}">@{{reply.parentUserName}}: </text>
                  <text>{{reply.content}}</text>
                </view>



                <!-- äºŒçº§è¯„è®ºçš„å›å¤è¾“å…¥æ¡† -->
                <view class="reply-input-container" wx:if="{{showReplyId === reply.id}}">
                  <input class="reply-input" placeholder="å›å¤ {{reply.userName}}..." bindinput="onReplyInput" value="{{replyContent}}"/>
                  <view class="reply-btns">
                    <button class="send-btn" bindtap="submitReply" data-id="{{reply.id}}" disabled="{{replyContent.trim()}}">å‘é€</button>
                  </view>
                </view>
              </view>
            </block>
          </view>

          <!-- ä¸€çº§è¯„è®ºçš„å›å¤è¾“å…¥æ¡† -->
          <view class="reply-input-container" wx:if="{{showReplyId === item.id}}">
            <input class="reply-input" placeholder="å›å¤ {{item.userName}}..." bindinput="onReplyInput" value="{{replyContent}}"/>
            <view class="reply-btns">
              <button class="send-btn" bindtap="submitReply" data-id="{{item.id}}" disabled="{{replyContent.trim()}}">å‘é€</button>
            </view>
          </view>
        </view>
      </block>
      <view class="no-comments" wx:if="{{comments.length === 0}}">
        <text>æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</text>
      </view>
    </scroll-view>
  </view>

  <!-- é˜²æ­¢å†’æ³¡äº‹ä»¶ -->
  <view class="stop-propagation" catchtap="stopPropagation"></view>

  <!-- é¢†å…»æŒ‰é’®å¸åº• -->
  <view class="adopt-btn-fixed">
    <button class="adopt-btn" bindtap="onAdopt" disabled="{{pet.isAdopt !== 'å¾…é¢†å…»'}}">
      <text class="btn-icon">ğŸ </text>
      <text class="btn-text">{{pet.isAdopt === 'å¾…é¢†å…»' ? 'ç”³è¯·é¢†å…»' : 'å·²è¢«é¢†å…»'}}</text>
    </button>
  </view>

  <!-- é¢†å…»ç”³è¯·è¡¨å•å¼¹çª— -->
  <view wx:if="{{showAdoptForm}}" class="adopt-form-mask" bindtap="onCloseAdoptForm">
    <view class="adopt-form" catchtap="stopPropagation">
      <view class="form-header">
        <text class="form-title">é¢†å…»ç”³è¯·</text>
        <view class="form-close" bindtap="onCloseAdoptForm">Ã—</view>
      </view>
      
      <view class="form-content">
        <view class="form-item">
          <text class="form-label">ç”³è¯·ç†ç”± <text class="required">*</text></text>
          <textarea 
            class="form-input" 
            placeholder="è¯·è¯¦ç»†è¯´æ˜æ‚¨æƒ³è¦é¢†å…»è¿™åªå® ç‰©çš„ç†ç”±..." 
            value="{{applyReason}}" 
            bindinput="onApplyReasonInput"
            maxlength="500"
          ></textarea>
          <text class="char-count">{{applyReason.length}}/500</text>
        </view>
        
        <view class="form-item">
          <text class="form-label">å…»å® ç»éªŒ <text class="required">*</text></text>
          <textarea 
            class="form-input" 
            placeholder="è¯·æè¿°æ‚¨çš„å…»å® ç»éªŒï¼ŒåŒ…æ‹¬æ˜¯å¦å…»è¿‡å® ç‰©ã€äº†è§£å® ç‰©æŠ¤ç†ç­‰..." 
            value="{{petExperience}}" 
            bindinput="onPetExperienceInput"
            maxlength="500"
          ></textarea>
          <text class="char-count">{{petExperience.length}}/500</text>
        </view>
        
        <view wx:if="{{adoptError}}" class="form-error">
          <text class="error-icon">âš ï¸</text>
          <text class="error-text">{{adoptErrorMsg}}</text>
        </view>
        
        <view class="form-buttons">
          <button class="form-btn cancel" bindtap="onCloseAdoptForm">
            <text class="btn-text">å–æ¶ˆ</text>
          </button>
          <button class="form-btn primary" loading="{{adoptLoading}}" bindtap="submitAdoptionApply">
            <text class="btn-text">{{adoptLoading ? 'æäº¤ä¸­...' : 'æäº¤ç”³è¯·'}}</text>
          </button>
        </view>
      </view>
    </view>
  </view>
</view>